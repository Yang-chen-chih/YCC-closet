<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ä½è¡£æ«ƒ - å°ˆæ¥­ä½ˆå±€ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-main: #FFF5E9; /* æš–è‰²èƒŒæ™¯ */
            --accent-primary: #5D5FEF;
            --text-main: #333333;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .accent-text { color: var(--accent-primary); }
        .accent-bg { background-color: var(--accent-primary); }

        #item-image-input { display: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type="range"] {
            accent-color: var(--accent-primary);
        }
    </style>
</head>
<body class="p-6 lg:p-12">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Top Section: Weather & Recommendations -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- å·¦ä¸Šï¼šå¤©æ°£æ•´é«”æ¦‚æ³ (ä½”æ¯” 4/12) -->
            <div class="lg:col-span-4 glass-card p-8 flex flex-col justify-between min-h-[300px]">
                <div>
                    <p class="text-[12px] font-bold text-gray-400 tracking-widest uppercase mb-4">å¤©æ°£æ•´é«”æ¦‚æ³</p>
                    <h2 class="text-2xl font-bold leading-relaxed">
                        ä»Šå¤©ã€Œ<span id="wx-desc">æ™´æ™‚å¤šé›²</span>ã€ï¼Œ<br>
                        æ°£æº«ç´„ <span id="temp-range">22Â°C è‡³ 28Â°C</span>ï¼Œ<br>
                        é«”æ„Ÿèˆ’é©ã€‚
                    </h2>
                </div>
                <div class="flex items-end justify-between">
                    <div class="text-6xl" id="weather-icon">ğŸŒ¤ï¸</div>
                    <div class="text-right">
                        <p class="text-[10px] font-black opacity-40 uppercase tracking-widest">ç›®å‰æº«æ„Ÿ</p>
                        <p class="text-3xl font-black" id="current-temp">25Â°C</p>
                    </div>
                </div>
            </div>

            <!-- å³ä¸Šï¼šä»Šæ—¥æ¦‚æ³èˆ‡å»ºè­° (ä½”æ¯” 8/12) -->
            <div class="lg:col-span-8 glass-card p-8 flex flex-col justify-between">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- é›¨å…·å»ºè­° -->
                    <div class="space-y-4">
                        <div>
                            <p class="text-[12px] font-bold text-gray-400 tracking-widest uppercase mb-2">é›¨å…·æ”œå¸¶å»ºè­°</p>
                            <h3 class="text-2xl font-bold text-green-600" id="rain-advice">ç„¡éœ€æ”œå¸¶é›¨å…·</h3>
                            <p class="text-sm text-gray-500">é å ±é™é›¨æ©Ÿç‡ <span id="pop-value">0%</span></p>
                        </div>
                        <div class="pt-4 border-t border-black/5">
                            <p class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1">DAILY MOOD</p>
                            <p class="text-xl font-bold italic text-orange-600" id="mood-text">é™½å…‰æ­£å¥½ï¼Œé©åˆå‡ºé–€èµ°èµ°ã€‚ â˜€ï¸</p>
                        </div>
                    </div>

                    <!-- ç©¿æ­çµ±è¨ˆèˆ‡å‹•ä½œ -->
                    <div class="flex flex-col justify-between items-end">
                        <div class="text-right w-full">
                            <p class="text-[12px] font-bold text-gray-400 tracking-widest uppercase mb-2">è¡£æ«¥ä½¿ç”¨é‡</p>
                            <div class="flex items-center justify-end gap-3 mb-1">
                                <span id="storage-text" class="text-xs font-black">0%</span>
                                <div class="w-32 h-1.5 bg-black/5 rounded-full overflow-hidden">
                                    <div id="storage-bar" class="h-full accent-bg transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 w-full justify-end">
                            <button onclick="recommendOutfit()" class="accent-bg text-white px-6 py-4 rounded-2xl text-xs font-black flex items-center gap-2 hover:scale-105 transition-all shadow-lg">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> AI ç©¿æ­å»ºè­°
                            </button>
                            <button onclick="clearCloset()" class="bg-red-50 text-red-500 px-6 py-4 rounded-2xl text-xs font-black hover:bg-red-100 transition-all">
                                æ¸…ç©º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section: My Closet -->
        <div class="glass-card p-8 min-h-[600px] flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 border-b border-black/5 pb-6">
                <div>
                    <h2 class="text-3xl font-black tracking-tight">æˆ‘çš„è¡£æ«ƒ</h2>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Manage your digital collection</p>
                </div>
                
                <nav class="flex bg-gray-100 p-1 rounded-2xl">
                    <button onclick="filterItems('all')" class="filter-btn px-6 py-2 text-xs font-bold rounded-xl bg-white shadow-sm transition-all">å…¨éƒ¨</button>
                    <button onclick="filterItems('tops')" class="filter-btn px-6 py-2 text-xs font-bold rounded-xl opacity-40 hover:opacity-100 transition-all">ä¸Šè¡£</button>
                    <button onclick="filterItems('bottoms')" class="filter-btn px-6 py-2 text-xs font-bold rounded-xl opacity-40 hover:opacity-100 transition-all">ä¸‹èº«</button>
                </nav>
            </div>

            <!-- Closet Grid -->
            <div id="closet-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-6 flex-grow">
                <!-- JS Items -->
            </div>

            <div id="empty-hint" class="hidden py-24 flex flex-col items-center justify-center text-center opacity-20">
                <i data-lucide="box" class="w-16 h-16 mb-4"></i>
                <p class="font-bold tracking-widest">ç›®å‰è¡£æ«ƒç©ºç©ºå¦‚ä¹Ÿ</p>
            </div>

            <!-- æ–°å¢è¡£ç‰©æµ®å‹•æ¬„ä½ (åº•éƒ¨) -->
            <div class="mt-12 pt-8 border-t border-black/5">
                <div class="flex flex-col lg:flex-row items-end gap-6">
                    <!-- Upload Area -->
                    <div class="w-full lg:w-48">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">è¡£ç‰©ç…§ç‰‡</label>
                        <div id="drop-zone" class="aspect-square rounded-3xl border-2 border-dashed border-gray-200 bg-white/50 flex flex-col items-center justify-center cursor-pointer hover:border-indigo-300 transition-all group" onclick="document.getElementById('item-image-input').click()">
                            <i data-lucide="plus-circle" class="w-6 h-6 text-gray-300 group-hover:text-indigo-400 transition-colors"></i>
                            <input type="file" id="item-image-input" accept="image/*">
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">åˆ†é¡</label>
                            <select id="cat-select" class="w-full h-14 px-4 rounded-2xl bg-white border border-gray-100 text-sm font-bold outline-none focus:ring-2 ring-indigo-500/20">
                                <option value="tops">ä¸Šè¡£ (Tops)</option>
                                <option value="bottoms">ä¸‹èº« (Bottoms)</option>
                                <option value="outerwear">å¤–å¥— (Outerwear)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">åšåº¦/æ¬Šé‡</label>
                            <div class="h-14 flex items-center px-4 bg-white rounded-2xl border border-gray-100">
                                <input type="range" id="warmth-range" min="0" max="100" value="50" class="w-full">
                            </div>
                        </div>
                    </div>

                    <button onclick="handleAddItem()" class="w-full lg:w-auto h-14 px-10 accent-bg text-white rounded-2xl font-black text-sm shadow-xl hover:brightness-110 active:scale-95 transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> æ–°å¢è¡£ç‰©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendation Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-300">
        <div class="glass-card bg-white max-w-lg w-full p-8 scale-90 transition-all duration-300" id="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black italic">TODAY'S LOOK</h3>
                <button onclick="closeModal()"><i data-lucide="x" class="w-6 h-6 opacity-30"></i></button>
            </div>
            <div id="outfit-display" class="flex justify-center gap-4 mb-8"></div>
            <p id="outfit-logic" class="text-center text-sm font-bold text-gray-500 bg-gray-50 p-4 rounded-2xl"></p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 bg-zinc-900 text-white text-[10px] font-black rounded-full shadow-2xl opacity-0 translate-y-4 transition-all duration-300 z-[200]"></div>

    <script>
        const CONFIG = {
            storageKey: 'VIRTUAL_CLOSET_V2',
            maxImgWidth: 500,
            localStorageLimit: 5 * 1024 * 1024
        };

        let state = {
            clothes: [],
            weather: { temp: 25, low: 22, high: 28, desc: 'æ™´æ™‚å¤šé›²', pop: 0 },
            currentFilter: 'all'
        };

        const Storage = {
            save: () => {
                const data = JSON.stringify(state.clothes);
                localStorage.setItem(CONFIG.storageKey, data);
                Storage.updateUsageUI();
            },
            load: () => {
                const saved = localStorage.getItem(CONFIG.storageKey);
                if (saved) state.clothes = JSON.parse(saved);
                Storage.updateUsageUI();
            },
            updateUsageUI: () => {
                const used = new Blob([localStorage.getItem(CONFIG.storageKey) || '']).size;
                const percent = Math.min(100, Math.round((used / CONFIG.localStorageLimit) * 100));
                document.getElementById('storage-bar').style.width = `${percent}%`;
                document.getElementById('storage-text').textContent = `${percent}%`;
            }
        };

        const Weather = {
            async fetch() {
                try {
                    const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=CWA-6CCF2861-4317-4000-BED2-E9BACDB2DEC3&locationName=è‡ºåŒ—å¸‚`);
                    const json = await res.json();
                    const el = json.records.location[0].weatherElement;
                    
                    const minT = el.find(e => e.elementName === "MinT").time[0].parameter.parameterName;
                    const maxT = el.find(e => e.elementName === "MaxT").time[0].parameter.parameterName;
                    const wx = el.find(e => e.elementName === "Wx").time[0].parameter.parameterName;
                    const pop = el.find(e => e.elementName === "PoP").time[0].parameter.parameterName;

                    state.weather = { 
                        temp: Math.round((parseInt(minT) + parseInt(maxT))/2),
                        low: minT, high: maxT, desc: wx, pop: pop 
                    };
                    this.updateUI();
                } catch (e) {
                    console.error(e);
                    this.updateUI();
                }
            },
            updateUI() {
                const { temp, low, high, desc, pop } = state.weather;
                document.getElementById('wx-desc').textContent = desc;
                document.getElementById('temp-range').textContent = `${low}Â°C è‡³ ${high}Â°C`;
                document.getElementById('current-temp').textContent = `${temp}Â°C`;
                document.getElementById('pop-value').textContent = `${pop}%`;
                
                // é›¨å…·èˆ‡å¿ƒæƒ…å»ºè­°
                const rainAdvice = document.getElementById('rain-advice');
                const moodText = document.getElementById('mood-text');
                const iconEl = document.getElementById('weather-icon');

                if (parseInt(pop) > 30) {
                    rainAdvice.textContent = "å»ºè­°æ”œå¸¶é›¨å…·";
                    rainAdvice.classList.replace('text-green-600', 'text-blue-600');
                    moodText.textContent = "é›¨å¤©ä¹Ÿè¦ä¿æŒå¥½å¿ƒæƒ…ã€‚ ğŸŒ§ï¸";
                    iconEl.textContent = 'ğŸŒ§ï¸';
                } else if (parseInt(high) > 28) {
                    moodText.textContent = "é™½å…‰æ­£å¥½ï¼Œé©åˆå‡ºé–€èµ°èµ°ã€‚ â˜€ï¸";
                    iconEl.textContent = 'â˜€ï¸';
                } else {
                    iconEl.textContent = 'ğŸŒ¤ï¸';
                }
            }
        };

        const Utils = {
            toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.replace('opacity-0', 'opacity-100');
                t.classList.replace('translate-y-4', 'translate-y-0');
                setTimeout(() => {
                    t.classList.replace('opacity-100', 'opacity-0');
                    t.classList.replace('translate-y-0', 'translate-y-4');
                }, 2000);
            },
            async compressImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ratio = CONFIG.maxImgWidth / img.width;
                            canvas.width = CONFIG.maxImgWidth;
                            canvas.height = img.height * ratio;
                            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                    };
                });
            }
        };

        function renderCloset() {
            const container = document.getElementById('closet-container');
            const hint = document.getElementById('empty-hint');
            const filtered = state.currentFilter === 'all' ? state.clothes : state.clothes.filter(c => c.category === state.currentFilter);
            
            if (filtered.length === 0) { 
                container.innerHTML = ''; 
                hint.classList.remove('hidden'); 
                return; 
            }
            
            hint.classList.add('hidden');
            container.innerHTML = filtered.map(item => `
                <div class="group relative aspect-[3/4] bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-xl transition-all border border-black/5">
                    <img src="${item.image}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button onclick="deleteItem('${item.id}')" class="p-3 bg-white text-red-500 rounded-full shadow-lg hover:scale-110 transition-transform">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="absolute bottom-2 left-2 right-2 p-2 bg-white/80 backdrop-blur-md rounded-xl flex justify-between items-center">
                        <span class="text-[9px] font-black uppercase opacity-40">${item.category}</span>
                        <span class="text-[9px] font-black">${item.warmth}%</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function handleAddItem() {
            const input = document.getElementById('item-image-input');
            if (!input.files[0]) return Utils.toast("è«‹å…ˆé¸æ“‡ç…§ç‰‡");
            
            const compressed = await Utils.compressImage(input.files[0]);
            const newItem = {
                id: Date.now().toString(),
                category: document.getElementById('cat-select').value,
                warmth: parseInt(document.getElementById('warmth-range').value),
                image: compressed
            };
            
            state.clothes.push(newItem);
            Storage.save();
            renderCloset();
            input.value = '';
            Utils.toast("å·²åŠ å…¥è¡£æ«ƒ");
        }

        function deleteItem(id) {
            state.clothes = state.clothes.filter(c => c.id !== id);
            Storage.save();
            renderCloset();
        }

        function filterItems(type) {
            state.currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const active = (type === 'all' && btn.textContent === 'å…¨éƒ¨') || 
                               (type === 'tops' && btn.textContent === 'ä¸Šè¡£') || 
                               (type === 'bottoms' && btn.textContent === 'ä¸‹èº«');
                if(active) btn.classList.add('bg-white', 'shadow-sm'), btn.classList.remove('opacity-40');
                else btn.classList.remove('bg-white', 'shadow-sm'), btn.classList.add('opacity-40');
            });
            renderCloset();
        }

        function recommendOutfit() {
            const tops = state.clothes.filter(c => c.category === 'tops');
            const bottoms = state.clothes.filter(c => c.category === 'bottoms');
            if (!tops.length || !bottoms.length) return Utils.toast("è«‹å…ˆæ–°å¢ä¸Šè¡£èˆ‡ä¸‹èº«");

            const target = (30 - state.weather.temp) * 3;
            const pick = (list) => list.sort((a,b) => Math.abs(a.warmth - target) - Math.abs(b.warmth - target))[0];
            const outfit = [pick(tops), pick(bottoms)];

            const display = document.getElementById('outfit-display');
            display.innerHTML = outfit.map(i => `<div class="w-32 aspect-[3/4] rounded-2xl overflow-hidden border-4 border-white shadow-xl"><img src="${i.image}" class="w-full h-full object-cover"></div>`).join('');
            document.getElementById('outfit-logic').textContent = `ä¾æ“šæ°£æº« ${state.weather.temp}Â°Cï¼Œç‚ºæ‚¨æŒ‘é¸äº†åˆé©åšåº¦çš„è¡£ç‰©ã€‚`;
            
            document.getElementById('modal-overlay').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').classList.remove('scale-90');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').classList.add('scale-90');
        }

        function clearCloset() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { state.clothes = []; Storage.save(); renderCloset(); } }

        Storage.load();
        Weather.fetch();
        renderCloset();
        lucide.createIcons();
    </script>
</body>
</html>
