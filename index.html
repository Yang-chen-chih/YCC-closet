<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ä½è¡£æ«ƒ - æ•ˆèƒ½å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-dynamic: #F8F8F8;
            --accent-dynamic: #5D5FEF;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dynamic);
            transition: background-color 0.8s ease;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 24px;
        }

        .drop-zone {
            border: 2px dashed rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .drop-zone.active {
            border-color: var(--accent-dynamic);
            background: rgba(93, 95, 239, 0.05);
        }

        .item-card img {
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .item-card:hover img {
            transform: scale(1.08);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }

        #item-image-input { display: none; }
    </style>
</head>
<body class="p-4 lg:p-10 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-8">
        <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
        <header class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- å¤©æ°£çœ‹æ¿ -->
            <div class="lg:col-span-4 glass-card p-6 flex flex-col justify-between min-h-[220px]">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Current Weather</p>
                        <h2 id="city-name" class="text-xl font-bold text-zinc-800">è‡ºåŒ—å¸‚</h2>
                    </div>
                    <div id="weather-icon" class="text-4xl animate-bounce">ğŸŒ¤ï¸</div>
                </div>
                
                <div class="flex items-end gap-3">
                    <span id="temp-display" class="text-5xl font-black tracking-tighter text-zinc-900">--Â°C</span>
                    <span id="desc-display" class="text-sm font-bold text-gray-500 mb-2">è®€å–ä¸­...</span>
                </div>

                <div class="mt-4 grid grid-cols-2 gap-4 pt-4 border-t border-black/5">
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase">é™é›¨æ©Ÿç‡</p>
                        <p id="pop-display" class="text-xs font-black">--%</p>
                    </div>
                    <div>
                        <p class="text-[9px] font-bold text-gray-400 uppercase">å»ºè­°</p>
                        <p id="weather-tip" class="text-xs font-black">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢å·¥å…·æ¬„ -->
            <div class="lg:col-span-8 glass-card p-6">
                <div class="flex items-center gap-2 mb-6">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center">
                        <i data-lucide="shirt" class="text-indigo-600 w-4 h-4"></i>
                    </div>
                    <h2 class="text-xl font-black text-zinc-800">æ·»åŠ æ–°æˆå“¡</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">é¡åˆ¥</label>
                        <select id="cat-select" class="w-full h-12 px-4 rounded-xl bg-white/50 border border-black/5 outline-none focus:border-indigo-500 transition-all text-sm font-medium">
                            <option value="tops">ä¸Šè¡£ (Tops)</option>
                            <option value="bottoms">ä¸‹èº« (Bottoms)</option>
                            <option value="outerwear">å¤–å¥— (Outerwear)</option>
                            <option value="shoes">é‹å­ (Shoes)</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">ä¿æš–æ¬Šé‡</label>
                        <input type="range" id="warmth-range" min="0" max="100" value="50" class="w-full h-12 accent-indigo-600">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">ä¸Šå‚³ç…§ç‰‡</label>
                        <div id="drop-zone" class="drop-zone h-12 rounded-xl flex items-center justify-center cursor-pointer overflow-hidden px-4" onclick="document.getElementById('item-image-input').click()">
                            <span id="file-label" class="text-xs font-bold text-gray-500 truncate">é»æ“Šæˆ–æ‹–æ‹½åœ–ç‰‡è‡³æ­¤</span>
                            <input type="file" id="item-image-input" accept="image/*">
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-24 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div id="storage-bar" class="h-full bg-indigo-500" style="width: 0%"></div>
                        </div>
                        <span id="storage-text" class="text-[9px] font-bold text-gray-400">å„²å­˜ç©ºé–“: 0%</span>
                    </div>
                    <button onclick="handleAddItem()" class="px-8 h-12 bg-zinc-900 text-white rounded-xl font-black text-xs hover:bg-black transition-all shadow-lg flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> ä¿å­˜è¡£ç‰©
                    </button>
                </div>
            </div>
        </header>

        <!-- è¡£æ«¥ä¸»é«” -->
        <section class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-black text-zinc-900">æˆ‘çš„è¡£æ«¥</h2>
                    <div class="flex bg-white/50 p-1 rounded-lg border border-black/5">
                        <button onclick="filterItems('all')" class="filter-btn px-3 py-1 text-[10px] font-black rounded-md bg-white shadow-sm transition-all">ALL</button>
                        <button onclick="filterItems('tops')" class="filter-btn px-3 py-1 text-[10px] font-black rounded-md text-gray-400 transition-all">TOPS</button>
                        <button onclick="filterItems('bottoms')" class="filter-btn px-3 py-1 text-[10px] font-black rounded-md text-gray-400 transition-all">BOTTOMS</button>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="recommendOutfit()" class="bg-indigo-600 text-white px-5 py-3 rounded-2xl text-xs font-black flex items-center gap-2 shadow-xl shadow-indigo-200 hover:scale-105 transition-transform">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> æ™ºèƒ½æ¨è–¦
                    </button>
                    <button onclick="clearCloset()" class="bg-white border border-red-100 text-red-400 px-5 py-3 rounded-2xl text-xs font-black hover:bg-red-50 transition-colors">
                        æ¸…ç©º
                    </button>
                </div>
            </div>

            <div id="closet-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                <!-- ç”± JS æ¸²æŸ“ -->
            </div>

            <div id="empty-hint" class="hidden py-32 glass-card flex flex-col items-center justify-center text-center">
                <i data-lucide="archive" class="w-12 h-12 text-gray-200 mb-4"></i>
                <p class="text-gray-400 font-bold text-sm tracking-widest uppercase">è¡£æ«¥ç›®å‰ç©ºç©ºå¦‚ä¹Ÿ</p>
            </div>
        </section>
    </div>

    <!-- æ¨è–¦çµæœå½ˆçª— -->
    <div id="modal-overlay" class="fixed inset-0 bg-zinc-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="glass-card bg-white/95 max-w-2xl w-full p-8 shadow-2xl scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <span class="text-[10px] font-black text-indigo-500 uppercase tracking-widest block mb-1">Outfit Recommendation</span>
                    <h3 class="text-2xl font-black text-zinc-900">ä»Šæ—¥æœ€ä½³ç©¿æ­ææ¡ˆ</h3>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            
            <div id="outfit-display" class="flex flex-wrap md:flex-nowrap gap-6 mb-8 items-center justify-center">
                <!-- ç©¿æ­çµæœ -->
            </div>

            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                <p id="outfit-logic" class="text-xs font-bold text-gray-500 italic"></p>
                <button onclick="closeModal()" class="px-6 py-2.5 bg-zinc-900 text-white rounded-xl text-xs font-black">æ”¶ä¸‹äº†</button>
            </div>
        </div>
    </div>

    <!-- è¨Šæ¯æç¤º -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-zinc-900 text-white text-xs font-bold rounded-full shadow-2xl opacity-0 transition-all duration-300 z-[200]"></div>

    <script>
        /** * 1. æ ¸å¿ƒç‹€æ…‹èˆ‡å¸¸é‡ 
         */
        const CONFIG = {
            storageKey: 'VIRTUAL_CLOSET_PRO_V1',
            maxImgWidth: 500,
            imgQuality: 0.7,
            localStorageLimit: 5 * 1024 * 1024 // ç´„ 5MB
        };

        let state = {
            clothes: [],
            weather: { temp: 22, desc: 'æ™´', pop: 0 },
            currentFilter: 'all'
        };

        /** * 2. å„²å­˜æ¨¡çµ„ (Storage Manager)
         */
        const Storage = {
            save: () => {
                const data = JSON.stringify(state.clothes);
                try {
                    localStorage.setItem(CONFIG.storageKey, data);
                    Storage.updateUsageUI();
                } catch (e) {
                    Utils.toast("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹åˆªé™¤éƒ¨åˆ†è¡£ç‰©");
                }
            },
            load: () => {
                const saved = localStorage.getItem(CONFIG.storageKey);
                if (saved) state.clothes = JSON.parse(saved);
                Storage.updateUsageUI();
            },
            updateUsageUI: () => {
                const used = new Blob([localStorage.getItem(CONFIG.storageKey) || '']).size;
                const percent = Math.min(100, Math.round((used / CONFIG.localStorageLimit) * 100));
                document.getElementById('storage-bar').style.width = `${percent}%`;
                document.getElementById('storage-text').textContent = `å„²å­˜ç©ºé–“: ${percent}%`;
            }
        };

        /** * 3. å¤©æ°£æ¨¡çµ„ (Weather Manager)
         */
        const Weather = {
            async fetch() {
                try {
                    const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=CWA-6CCF2861-4317-4000-BED2-E9BACDB2DEC3&locationName=è‡ºåŒ—å¸‚`);
                    const json = await res.json();
                    const el = json.records.location[0].weatherElement;
                    
                    state.weather = {
                        temp: parseInt(el.find(e => e.elementName === "MaxT").time[0].parameter.parameterName),
                        desc: el.find(e => e.elementName === "Wx").time[0].parameter.parameterName,
                        pop: parseInt(el.find(e => e.elementName === "PoP").time[0].parameter.parameterName)
                    };
                    this.updateUI();
                } catch (e) {
                    Utils.toast("å¤©æ°£è®€å–ç•°å¸¸ï¼Œä½¿ç”¨é è¨­å€¼");
                    this.updateUI();
                }
            },
            updateUI() {
                document.getElementById('temp-display').textContent = `${state.weather.temp}Â°C`;
                document.getElementById('desc-display').textContent = state.weather.desc;
                document.getElementById('pop-display').textContent = `${state.weather.pop}%`;
                
                const tip = state.weather.pop > 30 ? "å‡ºé–€è¨˜å¾—å¸¶å‚˜ â˜”" : 
                           state.weather.temp < 18 ? "å¤©æ°£è¼ƒå†·ï¼Œæ³¨æ„ä¿æš– ğŸ§¥" : "å¤©æ°£èˆ’é©ï¼Œé©åˆå‡ºéŠ ğŸ‘•";
                document.getElementById('weather-tip').textContent = tip;

                // å‹•æ…‹èƒŒæ™¯è‰²
                const colors = state.weather.temp > 28 ? ['#FFF1F1', '#F87171'] : 
                              state.weather.temp > 18 ? ['#F1F5FF', '#6366F1'] : ['#F0FDFA', '#14B8A6'];
                document.documentElement.style.setProperty('--bg-dynamic', colors[0]);
                document.documentElement.style.setProperty('--accent-dynamic', colors[1]);
            }
        };

        /** * 4. å·¥å…·å‡½æ•¸ (Utilities)
         */
        const Utils = {
            toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.style.opacity = '1';
                t.style.bottom = '40px';
                setTimeout(() => {
                    t.style.opacity = '0';
                    t.style.bottom = '10px';
                }, 2500);
            },
            async compressImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ratio = Math.min(CONFIG.maxImgWidth / img.width, 1);
                            canvas.width = img.width * ratio;
                            canvas.height = img.height * ratio;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', CONFIG.imgQuality));
                        };
                    };
                });
            }
        };

        /** * 5. UI æ§åˆ¶å™¨
         */
        function renderCloset() {
            const container = document.getElementById('closet-container');
            const hint = document.getElementById('empty-hint');
            const filtered = state.currentFilter === 'all' ? 
                           state.clothes : state.clothes.filter(c => c.category === state.currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = '';
                hint.classList.remove('hidden');
                return;
            }

            hint.classList.add('hidden');
            container.innerHTML = filtered.map(item => `
                <div class="item-card relative aspect-[3/4] rounded-2xl overflow-hidden glass-card group">
                    <img src="${item.image}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                        <button onclick="deleteItem('${item.id}')" class="p-2 bg-white text-red-500 rounded-xl shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="absolute bottom-2 left-2 px-2 py-0.5 bg-white/90 rounded-md text-[8px] font-black uppercase tracking-tighter shadow-sm">
                        ${item.category} | W:${item.warmth}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function handleAddItem() {
            const input = document.getElementById('item-image-input');
            if (!input.files[0]) return Utils.toast("è«‹å…ˆé¸æ“‡ä¸€å¼µç…§ç‰‡");

            const compressed = await Utils.compressImage(input.files[0]);
            const newItem = {
                id: Date.now().toString(),
                category: document.getElementById('cat-select').value,
                warmth: parseInt(document.getElementById('warmth-range').value),
                image: compressed
            };

            state.clothes.push(newItem);
            Storage.save();
            renderCloset();
            
            // é‡ç½® UI
            input.value = '';
            document.getElementById('file-label').textContent = "é»æ“Šæˆ–æ‹–æ‹½åœ–ç‰‡è‡³æ­¤";
            Utils.toast("æˆåŠŸæ”¶ç´è‡³è¡£æ«¥ âœ¨");
        }

        function deleteItem(id) {
            state.clothes = state.clothes.filter(c => c.id !== id);
            Storage.save();
            renderCloset();
        }

        function filterItems(type) {
            state.currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.textContent.toLowerCase() === type) {
                    btn.classList.add('bg-white', 'shadow-sm');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('bg-white', 'shadow-sm');
                    btn.classList.add('text-gray-400');
                }
            });
            renderCloset();
        }

        function recommendOutfit() {
            const tops = state.clothes.filter(c => c.category === 'tops');
            const bottoms = state.clothes.filter(c => c.category === 'bottoms');

            if (tops.length === 0 || bottoms.length === 0) {
                return Utils.toast("è¡£æ«¥è£¡çš„ä¸Šè¡£æˆ–è¤²å­æ•¸é‡ä¸è¶³ï¼Œç„¡æ³•æ­é…");
            }

            // ç°¡å–®æ¨è–¦é‚è¼¯ï¼šæ ¹æ“šæ°£æº«é¸æ“‡æ¥è¿‘æ‰€éœ€ä¿æš–åº¦çš„è¡£ç‰©
            // å‡è¨­ 20åº¦ éœ€è¦ ç¸½ä¿æš–åº¦ 100 (50+50)
            const targetWarmth = Math.max(0, (30 - state.weather.temp) * 5); // éš¨ä¾¿è¨­ä¸€å€‹é—œè¯æ•¸å€¼
            
            const pickBest = (list) => {
                return list.sort((a, b) => Math.abs(a.warmth - targetWarmth) - Math.abs(b.warmth - targetWarmth))[0];
            };

            const outfit = [pickBest(tops), pickBest(bottoms)];
            
            // é¡¯ç¤ºå½ˆçª—
            const overlay = document.getElementById('modal-overlay');
            const display = document.getElementById('outfit-display');
            const logicText = document.getElementById('outfit-logic');

            display.innerHTML = outfit.map(item => `
                <div class="w-40 aspect-[3/4] rounded-2xl overflow-hidden border-4 border-white shadow-xl">
                    <img src="${item.image}" class="w-full h-full object-cover">
                </div>
            `).join('<i data-lucide="plus" class="w-6 h-6 text-gray-300"></i>');

            logicText.textContent = `è€ƒæ…®åˆ°æ°£æº« ${state.weather.temp}Â°Cï¼Œæˆ‘å€‘ç‚ºæ‚¨æŒ‘é¸äº†ä¿æš–åº¦åˆé©çš„å–®å“ã€‚`;
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').classList.remove('scale-95');
            lucide.createIcons();
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('modal-content').classList.add('scale-95');
        }

        function clearCloset() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
                state.clothes = [];
                Storage.save();
                renderCloset();
            }
        }

        /** * 6. äº‹ä»¶ç›£è½ (Drag and Drop)
         */
        const dz = document.getElementById('drop-zone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('active'); });
        dz.addEventListener('dragleave', () => dz.classList.remove('active'));
        dz.addEventListener('drop', (e) => {
            e.preventDefault();
            dz.classList.remove('active');
            const files = e.dataTransfer.files;
            if(files.length) {
                document.getElementById('item-image-input').files = files;
                document.getElementById('file-label').textContent = files[0].name;
            }
        });

        document.getElementById('item-image-input').addEventListener('change', (e) => {
            if(e.target.files[0]) document.getElementById('file-label').textContent = e.target.files[0].name;
        });

        // åˆå§‹åŒ–åŸ·è¡Œ
        Storage.load();
        Weather.fetch();
        renderCloset();
        lucide.createIcons();
    </script>
</body>
</html>
