<style>
    /* ...原有樣式... */
    .btn-loading {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(1);
    }
</style>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'closet-pro-mood-link';

    let user = null;
    let clothes = [];
    let weatherThemeColor = "#5D5FEF";
    let weatherData = { temp: 25, desc: "晴天", pop: 0 };

    // --- 1. 用戶狀態管理與資料監聽 ---
    onAuthStateChanged(auth, (u) => {
        if (u) {
            user = u;
            // 優化點：增加排序與過濾，確保只抓到自己的衣服
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'clothes'),
                where("uid", "==", u.uid)
            );

            // 捕捉錯誤防止 Console 噴紅字
            onSnapshot(q, (s) => {
                clothes = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, (err) => {
                console.error("Firestore 監聽失敗 (請檢查規則):", err);
                if(err.code === 'permission-denied') showToast("權限不足，請檢查 Firebase Rules");
            });
            fetchWeather();
        } else {
            signInAnonymously(auth).catch(e => showToast("匿名登入失敗"));
        }
    });

    // --- 2. 圖片處理與壓縮 (防範 Firestore 1MB 限制) ---
    const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // 限制寬度提高效能
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // 壓縮品質 0.7
                };
            };
        });
    };

    // --- 3. 新增衣物優化 ---
    window.addItem = async () => {
        const fileInput = document.getElementById('item-image');
        const saveBtn = document.getElementById('save-btn');
        
        if (!user) return showToast("用戶尚未就緒");
        if (!fileInput.files[0]) return showToast("請選擇照片");

        try {
            saveBtn.disabled = true;
            saveBtn.classList.add('btn-loading');
            saveBtn.innerHTML = `處理中...`;

            const compressedBase64 = await compressImage(fileInput.files[0]);

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clothes'), {
                category: document.getElementById('item-category').value,
                warmth: parseInt(document.getElementById('item-warmth').value) || 0,
                image: compressedBase64,
                uid: user.uid,
                createdAt: Date.now()
            });

            showToast("成功加入衣櫃 ✨");
            fileInput.value = ""; // 清空
            document.getElementById('file-name-display').textContent = "選擇檔案";
        } catch (e) {
            console.error(e);
            showToast("儲存失敗");
        } finally {
            saveBtn.disabled = false;
            saveBtn.classList.remove('btn-loading');
            saveBtn.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> 儲存至衣櫃`;
            lucide.createIcons();
        }
    };

    // --- 4. 穿搭邏輯優化 (智能推薦) ---
    window.generateOutfit = (mode) => {
        if (clothes.length < 2) return showToast("衣服太少囉，多新增幾件吧！");

        const tops = clothes.filter(c => c.category === 'tops');
        const bottoms = clothes.filter(c => c.category === 'bottoms');
        const outerwear = clothes.filter(c => c.category === 'outerwear');

        if (tops.length === 0 || bottoms.length === 0) return showToast("缺少上衣或下身");

        let selected = [];
        if (mode === 'recommend') {
            // 根據氣溫過濾保暖度 (簡單演算法)
            // 20度以下推薦高保暖度，30度以上推薦低保暖度
            const targetWarmth = weatherData.temp > 28 ? 20 : (weatherData.temp < 15 ? 80 : 50);
            
            const sortByWarmth = (arr) => [...arr].sort((a, b) => 
                Math.abs(a.warmth - targetWarmth) - Math.abs(b.warmth - targetWarmth)
            );

            selected = [sortByWarmth(tops)[0], sortByWarmth(bottoms)[0]];
            
            // 冷天自動加外套
            if (weatherData.temp < 20 && outerwear.length > 0) {
                selected.push(sortByWarmth(outerwear)[0]);
            }
        } else {
            // 隨機
            const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
            selected = [rand(tops), rand(bottoms)];
        }

        renderOutfitModal(selected, mode);
    };

    function renderOutfitModal(items, mode) {
        const modal = document.getElementById('outfit-modal');
        const container = document.getElementById('modal-items');
        
        modal.classList.remove('hidden');
        document.getElementById('modal-desc').textContent = mode === 'recommend' 
            ? `氣溫 ${weatherData.temp}°C，為您挑選了合適保暖度的單品。` 
            : "隨機混搭，說不定有新靈感！";

        container.innerHTML = items.map(i => `
            <div class="flex-shrink-0 w-36 h-48 rounded-3xl overflow-hidden shadow-lg border-4 border-white bg-gray-100">
                <img src="${i.image}" class="w-full h-full object-cover">
            </div>
        `).join('');
    }

    // ...其他輔助函式 (deleteItem, showToast 等) 保持原樣但加入錯誤處理...
</script>
