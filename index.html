<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¡£æ«ƒ</title>
    <link rel="icon" href="64è¡£æ«ƒicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --bg-main: #FFF5E9;
            --accent-primary: #5D5FEF;
            --text-main: #333333;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.02);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .accent-bg { background-color: var(--accent-primary); }

        #item-image-input { display: none; }
        
        input[type="range"] {
            accent-color: var(--accent-primary);
        }

        .mood-highlight {
            color: #E67E22;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-6 lg:p-12">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Top Section: Weather & Helper -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- å·¦å´ï¼šå¤©æ°£æ•´é«”æ¦‚æ³ -->
            <div class="lg:col-span-5 glass-card p-10 flex flex-col min-h-[500px]">
                <div class="space-y-8 flex-grow">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-4 items-center">
                            <div class="text-4xl filter drop-shadow-md" id="weather-icon">â˜€ï¸</div>
                            <div>
                                <p class="text-[12px] font-bold text-gray-400 tracking-wider">å¤©æ°£æ•´é«”æ¦‚æ³</p>
                                <p class="text-[10px] text-gray-400 font-medium">å³æ™‚æ°£è±¡æ•¸æ“š</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">ç›®å‰æº«æ„Ÿ</p>
                            <p class="text-3xl font-black" id="current-temp">--Â°C</p>
                        </div>
                    </div>

                    <div class="pt-2">
                        <h2 class="text-2xl font-black leading-tight text-zinc-800">
                            ä»Šå¤©ã€Œ<span id="wx-desc">è®€å–ä¸­...</span>ã€ï¼Œ<br>
                            æ°£æº«ç´„ <span id="temp-range">--Â°C è‡³ --Â°C</span>ï¼Œ<br>
                            <span id="comfort-text">ç’°å¢ƒæ•¸æ“šæ›´æ–°ä¸­</span>
                        </h2>
                    </div>

                    <div class="space-y-1">
                        <p class="text-[12px] font-bold text-gray-400 tracking-wider">é›¨å…·æ”œå¸¶å»ºè­°</p>
                        <h3 class="text-xl font-black text-green-600" id="rain-advice">ç„¡éœ€æ”œå¸¶é›¨å…·</h3>
                        <p class="text-[12px] text-gray-400 font-medium">é å ±é™é›¨æ©Ÿç‡ <span id="pop-value">0%</span></p>
                    </div>
                </div>

                <div class="pt-8 border-t border-black/5">
                    <p class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-3">DAILY MOOD</p>
                    <p class="text-xl font-bold italic mood-highlight leading-relaxed" id="mood-text">
                        æ­£åœ¨æƒæè¡£æ«ƒèˆ‡æ°£å€™ç‹€æ³...
                    </p>
                </div>
            </div>

            <!-- å³å´ï¼šä»Šæ—¥ç©¿æ­åŠ©æ‰‹ -->
            <div id="helper-card" class="lg:col-span-7 glass-card p-10 flex flex-col justify-between min-h-[500px]">
                
                <div id="helper-initial" class="space-y-8 h-full flex flex-col justify-center">
                    <div class="space-y-6">
                        <div>
                            <div id="current-date" class="text-indigo-500 font-black text-lg mb-2 tracking-tighter"></div>
                            <p class="text-[14px] font-bold text-gray-400 tracking-widest uppercase mb-4">æ™ºèƒ½æ¼”ç®—æ³•ç©¿æ­åŠ©æ‰‹</p>
                            <h3 class="text-4xl font-black mb-4 leading-tight">ç‚ºæ‚¨åª’åˆæœ€èˆ’é©çš„è¡£ç‰©åšåº¦</h3>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 mt-8">
                        <button id="btn-recommend" onclick="recommendOutfit()" class="flex-grow accent-bg text-white px-8 py-6 rounded-[24px] text-lg font-black flex items-center justify-center gap-3 hover:scale-[1.02] active:scale-95 transition-all shadow-2xl shadow-indigo-200">
                            <i data-lucide="sparkles" class="w-6 h-6"></i> AI æ™ºèƒ½ç©¿æ­å»ºè­°
                        </button>
                    </div>
                </div>

                <div id="helper-result" class="hidden fade-in space-y-6 h-full flex flex-col">
                    <div class="flex justify-between items-center">
                        <p class="text-[14px] font-bold text-indigo-500 tracking-widest uppercase">AI æ™ºèƒ½åª’åˆçµæœ</p>
                        <button onclick="resetHelper()" class="text-sm font-bold text-gray-400 hover:text-indigo-500 flex items-center gap-2">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i> é‡æ–°æŒ‘é¸
                        </button>
                    </div>
                    
                    <div class="flex-grow flex flex-col items-center justify-center space-y-8">
                        <div id="outfit-display-area" class="flex justify-center gap-4 flex-wrap"></div>
                        <div class="max-w-md w-full space-y-4">
                            <div id="outfit-logic-text" class="text-center text-lg font-bold text-gray-600 bg-indigo-50/50 p-6 rounded-3xl border border-indigo-100"></div>
                            <div id="stat-bar" class="flex justify-between text-[10px] font-black text-indigo-400 uppercase tracking-widest px-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡£æ«ƒç®¡ç†å€åŸŸ -->
        <div class="glass-card p-10 min-h-[600px] flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10 border-b border-black/5 pb-8">
                <div>
                    <h2 class="text-4xl font-black tracking-tight">æˆ‘çš„è¡£æ«ƒ</h2>
                </div>
                
                <nav class="flex bg-zinc-100/80 p-1.5 rounded-2xl flex-wrap gap-1">
                    <button onclick="filterItems('all')" class="filter-btn px-6 py-2 text-sm font-black rounded-xl bg-white shadow-sm">å…¨éƒ¨</button>
                    <button onclick="filterItems('tops')" class="filter-btn px-6 py-2 text-sm font-black rounded-xl opacity-40">ä¸Šè¡£</button>
                    <button onclick="filterItems('pants')" class="filter-btn px-6 py-2 text-sm font-black rounded-xl opacity-40">è¤²å­</button>
                    <button onclick="filterItems('skirts')" class="filter-btn px-6 py-2 text-sm font-black rounded-xl opacity-40">è£™å­</button>
                    <button onclick="filterItems('shoes')" class="filter-btn px-6 py-2 text-sm font-black rounded-xl opacity-40">é‹å­</button>
                    <button onclick="filterItems('outerwear')" class="filter-btn px-6 py-2 text-sm font-black rounded-xl opacity-40">å¤–å¥—</button>
                </nav>
            </div>

            <div id="closet-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 flex-grow"></div>
            <div id="empty-hint" class="hidden py-32 flex flex-col items-center justify-center text-center opacity-10">
                <i data-lucide="box" class="w-20 h-20"></i>
                <p class="text-xl font-black">ç›®å‰è¡£æ«ƒæ˜¯ç©ºçš„</p>
            </div>

            <div class="mt-12 pt-10 border-t border-black/5">
                <div class="flex flex-col lg:flex-row items-end gap-8">
                    <div class="w-full lg:w-40 aspect-square rounded-[32px] border-2 border-dashed border-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-50" onclick="document.getElementById('item-image-input').click()">
                        <i data-lucide="plus" class="w-8 h-8 text-gray-300"></i>
                        <input type="file" id="item-image-input" accept="image/*">
                    </div>
                    <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-2">è¡£ç‰©é¡åˆ¥</label>
                            <select id="cat-select" class="w-full h-16 px-6 rounded-2xl bg-white border border-gray-100 font-bold outline-none focus:ring-2 focus:ring-indigo-200">
                                <option value="tops">ä¸Šè¡£</option>
                                <option value="pants">è¤²å­</option>
                                <option value="skirts">è£™å­</option>
                                <option value="shoes">é‹å­</option>
                                <option value="outerwear">å¤–å¥—</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label id="warmth-label" class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-2">ä¿æš–åšåº¦: 50%</label>
                            <div class="h-16 flex items-center px-6 bg-white rounded-2xl border border-gray-100">
                                <input type="range" id="warmth-range" min="0" max="100" value="50" class="w-full" oninput="document.getElementById('warmth-label').textContent=`ä¿æš–åšåº¦: ${this.value}%`">
                            </div>
                        </div>
                    </div>
                    <button onclick="handleAddItem()" class="h-16 px-12 accent-bg text-white rounded-2xl font-black hover:brightness-110 active:scale-95 transition-all">æ–°å¢è¡£ç‰©</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 bg-zinc-900 text-white text-xs font-black rounded-full shadow-2xl opacity-0 translate-y-6 transition-all duration-300 z-[200]"></div>

    <script>
        // --- æ ¸å¿ƒç‹€æ…‹ ---
        let state = { 
            clothes: [], 
            weather: { temp: 24, low: 20, high: 28, desc: 'è®€å–ä¸­', pop: 0 }, 
            currentFilter: 'all' 
        };

        const categoryNames = { 
            tops: 'ä¸Šè¡£', pants: 'è¤²å­', skirts: 'è£™å­', shoes: 'é‹å­', outerwear: 'å¤–å¥—' 
        };

        const Utils = {
            toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.classList.replace('opacity-0', 'opacity-100'); t.classList.replace('translate-y-6', 'translate-y-0');
                setTimeout(() => { t.classList.replace('opacity-100', 'opacity-0'); t.classList.replace('translate-y-0', 'translate-y-6'); }, 2000);
            },
            async compressImage(file) {
                return new Promise(resolve => {
                    const reader = new FileReader(); reader.readAsDataURL(file);
                    reader.onload = e => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = 400; canvas.height = (img.height / img.width) * 400;
                            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                    };
                });
            }
        };

        // --- å¤©æ°£æ¨¡çµ„ ---
        async function WeatherFetch() {
            try {
                // é è¨­æŠ“å–å°åŒ—å¸‚æ•¸æ“š
                const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=CWA-6CCF2861-4317-4000-BED2-E9BACDB2DEC3&locationName=è‡ºåŒ—å¸‚`);
                const json = await res.json();
                const el = json.records.location[0].weatherElement;
                
                const minT = parseInt(el.find(e => e.elementName === "MinT").time[0].parameter.parameterName);
                const maxT = parseInt(el.find(e => e.elementName === "MaxT").time[0].parameter.parameterName);
                
                state.weather = {
                    low: minT,
                    high: maxT,
                    temp: Math.round((minT + maxT) / 2), // ä»¥å‡æº«ä½œç‚ºåŸºç¤é«”æ„Ÿåƒè€ƒ
                    desc: el.find(e => e.elementName === "Wx").time[0].parameter.parameterName,
                    pop: el.find(e => e.elementName === "PoP").time[0].parameter.parameterName
                };
                UIUpdateWeather();
            } catch(e) { 
                console.error("Weather fetch failed", e);
                UIUpdateWeather(); 
            }
        }

        function UIUpdateWeather() {
            const { low, high, desc, pop, temp } = state.weather;
            document.getElementById('current-temp').textContent = `${temp}Â°C`;
            document.getElementById('wx-desc').textContent = desc;
            document.getElementById('temp-range').textContent = `${low}Â°C è‡³ ${high}Â°C`;
            document.getElementById('pop-value').textContent = `${pop}%`;
            document.getElementById('rain-advice').textContent = parseInt(pop) > 30 ? "å»ºè­°æ”œå¸¶é›¨å…·" : "ç„¡éœ€æ”œå¸¶é›¨å…·";
            document.getElementById('weather-icon').textContent = parseInt(pop) > 30 ? 'ğŸŒ§ï¸' : 'â˜€ï¸';
            
            let comfort = "é«”æ„Ÿèˆ’é©";
            if(temp < 18) comfort = "æ°£æº«åæ¶¼";
            if(temp < 14) comfort = "æ°£æº«å¯’å†·";
            if(temp > 28) comfort = "æ°£æº«ç‚ç†±";
            document.getElementById('comfort-text').textContent = comfort;

            const moodText = temp < 18 ? "å†·å†·çš„å¤©ï¼Œé©åˆç©¿æš–ä¸€é»ã€‚ â˜•" : "å¤©æ°£æº«å’Œï¼Œç°¡ç´„å‡ºé–€ã€‚ âœ¨";
            document.getElementById('mood-text').textContent = moodText;
        }

        // --- è¡£æ«ƒç®¡ç† ---
        function renderCloset() {
            const container = document.getElementById('closet-container');
            const filtered = state.currentFilter === 'all' ? state.clothes : state.clothes.filter(c => c.category === state.currentFilter);
            if (filtered.length === 0) { 
                container.innerHTML = ''; 
                document.getElementById('empty-hint').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('empty-hint').classList.add('hidden');
            
            container.innerHTML = filtered.map(item => `
                <div class="group relative aspect-[3/4] bg-white rounded-3xl overflow-hidden shadow-sm border border-black/5">
                    <img src="${item.image}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button onclick="deleteItem('${item.id}')" class="p-3 bg-white text-red-500 rounded-full shadow-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="absolute bottom-2 left-2 right-2 p-2 bg-white/90 rounded-xl flex justify-between items-center text-[10px] font-bold">
                        <span>${categoryNames[item.category]}</span>
                        <span class="text-indigo-600">${item.warmth}%</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function handleAddItem() {
            const input = document.getElementById('item-image-input');
            if (!input.files[0]) return Utils.toast("è«‹å…ˆé¸å–è¡£ç‰©ç…§ç‰‡");
            const img = await Utils.compressImage(input.files[0]);
            state.clothes.push({ 
                id: Date.now().toString(), 
                category: document.getElementById('cat-select').value, 
                warmth: parseInt(document.getElementById('warmth-range').value), 
                image: img 
            });
            localStorage.setItem('VIRTUAL_CLOSET_V4', JSON.stringify(state.clothes));
            renderCloset();
            Utils.toast("å·²æ”¶ç´è‡³è¡£æ«ƒ");
            input.value = "";
        }

        function deleteItem(id) { 
            state.clothes = state.clothes.filter(c => c.id !== id); 
            localStorage.setItem('VIRTUAL_CLOSET_V4', JSON.stringify(state.clothes)); 
            renderCloset(); 
        }

        function filterItems(type) { 
            state.currentFilter = type; 
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.getAttribute('onclick').includes(`'${type}'`);
                btn.className = isActive ? "filter-btn px-6 py-2 text-sm font-black rounded-xl bg-white shadow-sm" : "filter-btn px-6 py-2 text-sm font-black rounded-xl opacity-40";
            });
            renderCloset(); 
        }

        // --- æ ¸å¿ƒæ¨è–¦æ¼”ç®—æ³• ---
        function recommendOutfit() {
            const { temp } = state.weather;
            
            // 1. è¨ˆç®—éœ€æ±‚ä¿æš–åº¦ (æ°£æº«è¶Šä½ï¼Œéœ€æ±‚ä¿æš–åº¦è¶Šé«˜)
            // é‚è¼¯å‡è¨­ï¼š30åº¦ä»¥ä¸Šéœ€è¦10%åšåº¦ï¼Œ10åº¦ä»¥ä¸‹éœ€è¦90%åšåº¦
            let targetWarmth = Math.max(10, Math.min(90, (35 - temp) * 4));

            // 2. ç²å–åˆ†é¡è¡£ç‰©
            const tops = state.clothes.filter(c => c.category === 'tops');
            const bottoms = state.clothes.filter(c => (c.category === 'pants' || c.category === 'skirts'));
            const outers = state.clothes.filter(c => c.category === 'outerwear');
            const shoes = state.clothes.filter(c => c.category === 'shoes');

            if (tops.length === 0 || bottoms.length === 0) {
                return Utils.toast("è¡£æ«ƒä¸­è‡³å°‘éœ€è¦ä¸€ä»¶ä¸Šè¡£å’Œä¸€ä»¶ä¸‹èº«è¡£ç‰©");
            }

            // 3. æœå°‹æœ€ä½³çµ„åˆ (Brute Force å°‹æ‰¾èˆ‡ targetWarmth æœ€æ¥è¿‘çš„)
            let bestCombo = null;
            let minDiff = 999;

            for (let t of tops) {
                for (let b of bottoms) {
                    // åŸºæœ¬çµ„åˆï¼šä¸Šè¡£ + ä¸‹èº«
                    let baseAvg = (t.warmth + b.warmth) / 2;
                    let comboItems = [t, b];
                    let currentAvg = baseAvg;

                    // å¦‚æœä¿æš–åº¦ä¸è¶³ï¼Œå˜—è©¦åŠ å…¥å¤–å¥—
                    if (baseAvg < targetWarmth - 10 && outers.length > 0) {
                        // æ‰¾ä¸€ä»¶å¤–å¥—è©¦è©¦
                        for (let o of outers) {
                            let withOuterAvg = (t.warmth + b.warmth + o.warmth) / 3;
                            let diff = Math.abs(withOuterAvg - targetWarmth);
                            if (diff < minDiff) {
                                minDiff = diff;
                                bestCombo = { items: [t, b, o], avg: Math.round(withOuterAvg) };
                            }
                        }
                    } else {
                        // ä¸ç©¿å¤–å¥—çš„æƒ…æ³
                        let diff = Math.abs(baseAvg - targetWarmth);
                        if (diff < minDiff) {
                            minDiff = diff;
                            bestCombo = { items: comboItems, avg: Math.round(baseAvg) };
                        }
                    }
                }
            }

            if (!bestCombo) return Utils.toast("æ‰¾ä¸åˆ°åˆé©çš„ç©¿æ­çµ„åˆ");

            // 4. UI å‘ˆç¾
            document.getElementById('helper-initial').classList.add('hidden');
            document.getElementById('helper-result').classList.remove('hidden');
            
            const displayArea = document.getElementById('outfit-display-area');
            const logicText = document.getElementById('outfit-logic-text');
            const statBar = document.getElementById('stat-bar');

            // å¦‚æœæœ‰é‹å­ï¼Œé †ä¾¿å¡ä¸€å€‹é€²å»ï¼ˆä¸è¨ˆå…¥ä¿æš–åº¦è¨ˆç®—ï¼‰
            if (shoes.length > 0) {
                bestCombo.items.push(shoes[0]);
            }

            displayArea.innerHTML = bestCombo.items.map(i => `
                <div class="group relative w-24 sm:w-32 aspect-[3/4] rounded-2xl overflow-hidden border-4 border-white shadow-lg fade-in">
                    <img src="${i.image}" class="w-full h-full object-cover">
                    <div class="absolute bottom-1 right-1 bg-white/80 px-1.5 py-0.5 rounded text-[8px] font-black">${categoryNames[i.category]}</div>
                </div>
            `).join('');

            logicText.innerHTML = `
                ç›®å‰é«”æ„Ÿ <span class="text-indigo-600">${temp}Â°C</span>ï¼Œ<br>
                æœ€èˆ’é©åšåº¦ç´„ç‚º <span class="text-indigo-600">${Math.round(targetWarmth)}%</span>ã€‚<br>
                æ¨è–¦é€™å¥—çµ„åˆï¼Œå¹³å‡åšåº¦ç‚º <span class="text-indigo-600">${bestCombo.avg}%</span>ã€‚
            `;

            statBar.innerHTML = `
                <span>éœ€æ±‚åšåº¦: ${Math.round(targetWarmth)}%</span>
                <span>åª’åˆåšåº¦: ${bestCombo.avg}%</span>
            `;

            lucide.createIcons();
        }

        function resetHelper() { 
            document.getElementById('helper-result').classList.add('hidden'); 
            document.getElementById('helper-initial').classList.remove('hidden'); 
        }

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            const saved = localStorage.getItem('VIRTUAL_CLOSET_V4');
            if(saved) state.clothes = JSON.parse(saved);
            
            const now = new Date();
            const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            document.getElementById('current-date').textContent = 
                `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ Â· æ˜ŸæœŸ${days[now.getDay()]}`;
            
            WeatherFetch();
            renderCloset();
            lucide.createIcons();
        };
    </script>
</body>
</html>

